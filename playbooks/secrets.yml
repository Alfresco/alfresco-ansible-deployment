---
- hosts: localhost
  gather_facts: false
  vars:
    base_folder: "{{ playbook_dir }}/.."
  tasks:
    - name: Ensure no secrets are still set as group_vars
      fail:
        msg: "Secrets needs to be encrypted in vars/secrets.yml, see upgrade docs"
      when: lookup('file', base_folder + '/group_vars/all.yml').find('_db_password') != -1

    - name: Check if secrets.yml already contains secrets
      ansible.builtin.stat:
        path: "{{ base_folder }}/vars/secrets.yml"
      register: secrets_file

    - name: Populate secrets.yml with autogenerated secrets
      ansible.builtin.shell: "{{ base_folder }}/scripts/generate-secrets.sh > {{ base_folder }}/vars/secrets.yml"
      when: secrets_file.stat.isreg is not defined or secrets_file.stat.size == 0

    - name: Load secrets as localhost hostvars
      include_vars:
        file: ../vars/secrets.yml

    - name: Ensure that all available secrets are properly set
      assert:
        that:
          - repo_db_password is defined and repo_db_password | length > 0
          - sync_db_password is defined and sync_db_password | length > 0
          - reposearch_shared_secret is defined and reposearch_shared_secret | length > 0
          - activemq_password is defined and activemq_password | length > 0
        msg: "Secrets must be provided in vars/secrets.yml before running the playbook"
        quiet: true

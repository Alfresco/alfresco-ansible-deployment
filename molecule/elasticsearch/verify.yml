- name: Verify
  hosts: all
  gather_facts: false
  tasks:
    - name: Populate service facts
      ansible.builtin.service_facts:

    - name: Check that Elasticsearch Connector service is up and running
      ansible.builtin.assert:
        that:
          - ansible_facts.services['elasticsearch-connector.service'] is defined
          - ansible_facts.services['elasticsearch-connector.service'].state == 'running'

    - name: Get errors in the journal of Elasticsearch Connector service
      become: true
      ansible.builtin.shell: journalctl -u elasticsearch-connector.service
      register: error_log

    - name: Check logs for errors and warnings
      ansible.builtin.assert:
        that:
          - not error_log.stdout | regex_search(' WARN ')
          - not error_log.stderr | regex_search(' ERROR ')

    - name: Check that Elasticsearch Connector reindex service is defined and not running
      ansible.builtin.assert:
        that:
          - ansible_facts.services['elasticsearch-connector-reindex.service'] is defined
          - ansible_facts.services['elasticsearch-connector-reindex.service'].state == 'inactive'

- name: Run the Elasticsearch Connector Reindex
  import_playbook: ../../playbooks/search-enterprise-reindex.yml

- name: Verify Reindex
  hosts: all
  gather_facts: false
  tasks:
    - name: Get errors in the journal of Elasticsearch Connector Reindex service
      become: true
      ansible.builtin.shell: journalctl -u elasticsearch-connector-reindex.service
      register: error_log

    - name: Check logs for errors and warnings
      ansible.builtin.assert:
        that:
          - not error_log.stdout | regex_search(' WARN ')
          - not error_log.stderr | regex_search(' ERROR ')

- name: Run default verify
  import_playbook: ../default/verify.yml

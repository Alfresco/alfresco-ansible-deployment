---
- name: Default cleanup
  import_playbook: ../default/cleanup.yml

- name: Multimachine cleanup
  hosts: localhost
  gather_facts: false
  vars:
    project_dir: "{{ lookup('env', 'MOLECULE_PROJECT_DIRECTORY') }}"
  tasks:
    - name: Destroy Shared contentstore
      community.aws.efs:
        state: absent
        name: molecule-{{ lookup('env', 'BUILD_NUMBER') }}
      when: molecule_yml.platforms | selectattr('name', 'in', groups.repository) | length > 1
      register: contentstore

    - name: Reset repo host_vars files
      blockinfile:
        state: absent
        block: |
          cs_storage:
            type: nfs
            device: {{ item | map('extract', hostvars, ['cs_storage','device']) }}
            options: _netdev,noatime,nodiratime,tcp,soft,intr
        path: host_vars/{{ item }}.yml
      loop: "{{ molecule_yml.platforms | selectattr('name', 'in', groups.repository) | map(attribute='name') }}"

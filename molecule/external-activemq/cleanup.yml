---
- name: Default cleanup
  import_playbook: ../default/cleanup.yml

- name: External activemq cleanup
  hosts: localhost
  gather_facts: false
  vars:
    broker_name: molecule-{{ lookup('env', 'BUILD_NUMBER') }}
  tasks:

    - name: Grab activemq broker id
      ansible.builtin.command: |
        aws mq describe-broker --broker-id {{ broker_name }}
      register: describe_broker_output

    - name: Set broker-id
      set_fact:
        broker_id: "{{ (describe_broker_output.stdout | from_json).BrokerId }}"
      when: describe_broker_output.stdout | length > 0

    - name: Destroy mq broker
      ansible.builtin.command: |
        aws mq delete-broker --broker-id {{ broker_id }}
      when: broker_id is defined

    - name: Wait for destroy mq broker
      ansible.builtin.shell: |
        aws mq describe-broker --broker-id {{ broker_id }} || true
      when: broker_id is defined
      register: wait_describe_broker_output
      until: wait_describe_broker_output.stderr.find("NotFoundException") != -1
      retries: 20
      delay: 30

    - name: Delete EC2 security group for mq broker
      amazon.aws.ec2_group:
        name: molecule-{{ lookup('env', 'BUILD_NUMBER') }}
        state: absent

---
- name: Prepare
  hosts: all
  gather_facts: false
  tasks:
    - name: Make sure python3 is installed
      package:
        name: python3
        state: present
      become: true

    - amazon.aws.ec2_metadata_facts:

    - name: "Set variables"
      set_fact:
        project_dir: "{{ lookup('env', 'MOLECULE_PROJECT_DIRECTORY') }}"
        certificate_domain: "{{ ansible_ec2_public_hostname }}"

    - name: Create private key (RSA, 4096 bits)
      delegate_to: localhost
      community.crypto.openssl_privatekey:
        path: "{{ project_dir }}/configuration_files/ssl_certificates/{{ certificate_domain }}.key"

    - name: Create CSR for {{ certificate_domain }} self-signed certificate
      delegate_to: localhost
      community.crypto.openssl_csr_pipe:
        privatekey_path: "{{ project_dir }}/configuration_files/ssl_certificates/{{ certificate_domain }}.key"
        common_name: "{{ certificate_domain }}"
        organization_name: Hyland
      register: csr

    - name: Create self-signed certificate from CSR
      delegate_to: localhost
      community.crypto.x509_certificate:
        path: "{{ project_dir }}/configuration_files/ssl_certificates/{{ certificate_domain }}.crt"
        csr_content: "{{ csr.csr }}"
        privatekey_path: "{{ project_dir }}/configuration_files/ssl_certificates/{{ certificate_domain }}.key"
        provider: selfsigned

    - name: Configure FQDN in extra vars file
      delegate_to: localhost
      ansible.builtin.replace:
        path: "{{ project_dir }}/tests/test-ssl.yml"
        regexp: 'TEST_FQDN'
        replace: '{{ certificate_domain }}'
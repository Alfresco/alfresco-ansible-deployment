name: Delete MQ Configurations
permissions:
  id-token: write
  contents: read
on:
  push:
    branches:
      - OPSEXP-3170
  workflow_dispatch:  

jobs:
  delete-mq-configs:
    runs-on: ubuntu-latest
    steps:
      # - name: Login to AWS
      #   uses: aws-actions/configure-aws-credentials@b47578312673ae6fa5b5096b330d9fbac3d116df # v4.2.1
      #   with:
      #     aws-region: eu-west-1
      #     role-to-assume: arn:aws:iam::372466110691:role/AlfrescoCI/alfresco-cloud-deploy
      #     role-session-name: ${{ github.event.repository.name }}-${{ github.run_id }}
      #     role-duration-seconds: 5400    
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@b47578312673ae6fa5b5096b330d9fbac3d116df # v4.2.1
        with:
          aws-access-key-id: ${{ secrets.AWS_ANSIBLE_MANAGED_SERVICE_DEV_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_ANSIBLE_MANAGED_SERVICE_DEV_SECRET_ACCESS_KEY}}
          aws-region: eu-west-1
      - name: List MQ 
        run: |
          aws mq list-configurations \
            --no-paginate \
            --query "Configurations[?starts_with(Name, 'molecule-')].[Id,Name,EngineType,EngineVersion]" \
            --query "Configurations[?starts_with(Name, 'molecule-')].[Id,Name,EngineType,Created,LatestRevision.Created,EngineVersion]" \
            --output table  
      - name: Test Pagination for MQ Configurations
        run: |
          aws mq list-configurations \
            --max-results 100 \
            --query "Configurations[?starts_with(Name, 'molecule-')].[Id,Name,EngineType,Created,LatestRevision.Created,EngineVersion]" \
            --output table       
      - name: Delete old MQ configurations using pagination
        run: |
          set -e
          retention_days=30
          threshold_epoch=$(date -d "$retention_days days ago" +"%s")

          count_total=0
          count_deleted=0
          page_token=""

          echo "Scanning MQ configurations older than $retention_days days..."

          while true; do
            if [ -z "$page_token" ]; then
              response=$(aws mq list-configurations --max-results 100 --output json)
            else
              response=$(aws mq list-configurations --max-results 100 --starting-token "$page_token" --output json)
            fi

            configs=$(echo "$response" | jq -c '.Configurations[]?')
            page_token=$(echo "$response" | jq -r '.NextToken')

            echo "$configs" | while read -r config; do
              id=$(jq -r '.Id' <<< "$config")
              name=$(jq -r '.Name' <<< "$config")
              created=$(jq -r '.LatestRevision.Created' <<< "$config")

              created_clean="${created%%.*}"
              created_epoch=$(date -d "$created_clean" +"%s" 2>/dev/null || \
                              date -j -f "%Y-%m-%dT%H:%M:%S" "$created_clean" +"%s" || echo 0)

              age_days=$(( ( $(date -u +"%s") - created_epoch ) / 86400 ))
              count_total=$((count_total + 1))

              # Check if attached to any broker
              attached=$(aws mq list-brokers \
                --query "BrokerSummaries[?Configuration.Id=='$id'].BrokerId" \
                --output text)

              if [ -n "$attached" ]; then
                echo "In use, skipping: $name ($id) ‚Äî broker: $attached"
                continue
              fi

              if [ "$created_epoch" -lt "$threshold_epoch" ]; then
                echo "üóëÔ∏è Deleting: $name ($id), created $age_days days ago"
                count_deleted=$((count_deleted + 1))
              else
                echo "skipped: $name ($id), created $age_days days ago"
              fi
            done

            [ "$page_token" == "null" ] || [ -z "$page_token" ] && break
          done

          echo "--------------------------------------------------"
          echo "Total configurations checked: $count_total"
          echo "Total configurations deleted: $count_deleted
      - name: Delete MQ 
        run: |
          retention_days=30
          now=$(date -u +"%s")
          count=0
          count_skip=0

          configs=$(aws mq list-configurations \
            --no-paginate \
            --query "Configurations[?starts_with(Name, 'molecule-')].{ID:Id, Name:Name, Created:LatestRevision.Created}" \
            --output json)          
          while read -r config; do
            config_id=$(jq -r '.ID' <<< "$config")
            config_name=$(jq -r '.Name' <<< "$config")
            created=$(jq -r '.Created' <<< "$config")

            created_epoch=$(date -d "${created%%.*}" +"%s" 2>/dev/null || \
                            date -j -f "%Y-%m-%dT%H:%M:%S" "${created%%.*}" +"%s")
            age_days=$(( (now - created_epoch) / 86400 ))

            if [ "$age_days" -gt "$retention_days" ]; then
              echo "Deleting configuration $config_name (ID: $config_id, Age: $age_days days)"
              count=$((count + 1))
            else
              echo "Skipping configuration $config_name (ID: $config_id, Age: $age_days days)"
              count_skip=$((count_skip + 1))
            fi
          done < <(echo "$configs" | jq -c '.[]')

          echo "delete count: $count"
          echo "skip count: $count_skip"






---
os: linux
dist: xenial
language: python
python:
  - "3.8.2"
cache: pip

services:
  - docker

before_install:
  - pip install ansible molecule ansible-lint PyHamcrest pylint testinfra 

env:
  - MOLECULE_NO_LOG=false

install: pip install 'molecule[docker]'

stages:
  - name: Linters
  - name: Unit tests

jobs:
  include:
    - stage: Linters
      name: "ansible-lint"
      install: pip install --upgrade ansible-lint
      script:
        - ansible-lint -v playbooks/acs.yml
    - name: "pylint"
      install: pip install --upgrade pylint
      script:
        - find . -name "*.py" ! -name __init__.py | xargs pylint
    - name: "yamllint"
      install: pip install --upgrade yamllint
      script:
        - yamllint .
    - stage: Unit tests
      name: Search Role unit tests
      script:
        - cd roles/search/ && molecule test     
    - stage: Unit tests
      name: Common Role unit tests
      script:
        - cd roles/common/ && molecule test
    - stage: Unit tests
      name: Java Role unit tests
      script:
        - cd roles/java/ && molecule test
    - stage: Unit tests
      name: Tomcat Role unit tests
      script:
        - cd roles/tomcat/ && molecule test
    - stage: Unit tests
      name: ActiveMQ Role unit tests
      script:
        - cd roles/activemq/ && molecule test
    - stage: Unit tests
      name: Repository Role unit tests
      script:
        - cd roles/repository/ && molecule test
    - stage: Unit tests
      name: ADW Role unit tests
      script:
        - cd roles/adw/ && molecule test
    - stage: Unit tests
      name: Nginx Role unit tests
      script:
        - cd roles/nginx/ && molecule test
    - stage: Unit tests
      name: Transform AIO unit tests
      script:
        - cd roles/transformers/ && molecule test

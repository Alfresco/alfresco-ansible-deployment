---
os: linux
dist: xenial
language: python
python:
  - "3.9.0"

services:
  - docker

branches:
  only:
    - master
    - contribs
    - /feature.*/
    - /fix.*/
    - /OPSEXP-.*/
    - /^dependabot\/.*$/

env:
  global:
    - BRANCH_NAME="${TRAVIS_BRANCH}"
    - BUILD_NUMBER="${TRAVIS_BUILD_NUMBER}"
    - MOLECULE_NO_LOG=false
    - MOLECULE_IT_PATH=molecule/default
    - ANSIBLE_VERSION="2.9.21"
    - AWS_REGION=us-east-1
    - DTAS_VERSION=v1.1.1
    - "MOLECULE_ROLE_IMAGE=ubuntu:20.04"

before_install:
  - travis_retry pip install ansible==${ANSIBLE_VERSION}
  - travis_retry ansible-galaxy collection install community.docker amazon.aws community.crypto

script:
  - |
    molecule -e $MOLECULE_IT_PATH/$MOLECULE_IT_CONFIG converge && \
    molecule -e $MOLECULE_IT_PATH/$MOLECULE_IT_CONFIG verify
after_script:
  - |
    if [ -n "$MOLECULE_IT_CONFIG" ]; then
      molecule -e $MOLECULE_IT_PATH/$MOLECULE_IT_CONFIG destroy
    fi

stages:
  - name: Linters
  - name: Roles tests
  - name: Integration tests
  - name: Release Stage
    if: branch = master AND commit_message =~ /\[release\]/

jobs:
  include:
    - stage: Linters
      name: "ansible-lint"
      script:
        - ansible-lint -v playbooks/acs.yml

    - name: "pylint"
      script:
        - find . -name "*.py" ! -name __init__.py | xargs pylint

    - name: "yamllint"
      script:
        - yamllint .

    - name: Check components version table
      script:
        - python3 scripts/generate-comp-ver-table.py
        - git_status_out=$(git status)
        - if [[ "$git_status_out" == *"docs/README.md"* ]]; then echo "Error- Components version was not changed. Download pre-commit tool";exit 1; fi

    - stage: Roles tests
      name: Search Role Verification on Centos
      env:
        - "MOLECULE_ROLE_IMAGE=centos:7"
      script:
        - cd roles/search && molecule test

    - stage: Roles tests
      name: Search Role Verification on Ubuntu
      env:
        - "MOLECULE_ROLE_IMAGE=ubuntu:20.04"
      script:
        - cd roles/search && molecule test

    - stage: Roles tests
      name: Common Role Verification on Centos
      env:
        - "MOLECULE_ROLE_IMAGE=centos:7"
      script:
        - cd roles/common/ && molecule test

    - stage: Roles tests
      name: Common Role Verification on Ubuntu
      env:
        - "MOLECULE_ROLE_IMAGE=ubuntu:20.04"
      script:
        - cd roles/common/ && molecule test

    - stage: Roles tests
      name: Java Role Verification on Centos
      env:
        - "MOLECULE_ROLE_IMAGE=centos:7"
      script:
        - cd roles/java/ && molecule test

    - stage: Roles tests
      name: Java Role Verification on Ubuntu
      env:
        - "MOLECULE_ROLE_IMAGE=ubuntu:20.04"
      script:
        - cd roles/java/ && molecule test

    - stage: Roles tests
      name: Tomcat Role Verification on Centos
      env:
        - "MOLECULE_ROLE_IMAGE=centos:7"
      script:
        - cd roles/tomcat/ && molecule test

    - stage: Roles tests
      name: Tomcat Role Verification on Ubuntu
      env:
        - "MOLECULE_ROLE_IMAGE=ubuntu:20.04"
      script:
        - cd roles/tomcat/ && molecule test

    - stage: Roles tests
      name: ActiveMQ Role Verification on Centos
      env:
        - "MOLECULE_ROLE_IMAGE=centos:7"
      script:
        - cd roles/activemq/ && molecule test

    - stage: Roles tests
      name: ActiveMQ Role Verification on Ubuntu
      env:
        - "MOLECULE_ROLE_IMAGE=ubuntu:20.04"
      script:
        - cd roles/activemq/ && molecule test

    - stage: Roles tests
      name: Repository Role Verification on Centos
      env:
        - "MOLECULE_ROLE_IMAGE=centos:7"
      script:
        - cd roles/repository/
        - molecule converge
        - sleep 5m
        - travis_wait 30 molecule verify
        - molecule destroy

    - stage: Roles tests
      name: Repository Role Verification on Ubuntu
      env:
        - "MOLECULE_ROLE_IMAGE=ubuntu:20.04"
      script:
        - cd roles/repository/
        - molecule converge
        - sleep 5m
        - travis_wait 30 molecule verify
        - molecule destroy

    - stage: Roles tests
      name: ADW Role Verification on Centos
      env:
        - "MOLECULE_ROLE_IMAGE=centos:7"
      script:
        - cd roles/adw/ && molecule test

    - stage: Roles tests
      name: ADW Role Verification on Ubuntu
      env:
        - "MOLECULE_ROLE_IMAGE=ubuntu:20.04"
      script:
        - cd roles/adw/ && molecule test

    - stage: Roles tests
      name: Nginx Role Verification on Centos
      env:
        - "MOLECULE_ROLE_IMAGE=centos:7"
      script:
        - cd roles/nginx/ && molecule test

    - stage: Roles tests
      name: Nginx Role Verification on Ubuntu
      env:
        - "MOLECULE_ROLE_IMAGE=ubuntu:20.04"
      script:
        - cd roles/nginx/ && molecule test

    - stage: Roles tests
      name: SFS Role Verification on Centos
      env:
        - "MOLECULE_ROLE_IMAGE=centos:7"
      script:
        - cd roles/sfs/ && molecule test

    - stage: Roles tests
      name: SFS Role Verification on Ubuntu
      env:
        - "MOLECULE_ROLE_IMAGE=ubuntu:20.04"
      script:
        - cd roles/sfs/ && molecule test

    - stage: Roles tests
      name: Trouter Role Verification on Centos
      env:
        - "MOLECULE_ROLE_IMAGE=centos:7"
      script:
        - cd roles/trouter
        - molecule converge
        - sleep 1m
        - molecule verify
        - molecule destroy

    - stage: Roles tests
      name: Trouter Role Verification on Ubuntu
      env:
        - "MOLECULE_ROLE_IMAGE=ubuntu:20.04"
      script:
        - cd roles/trouter
        - molecule converge
        - sleep 1m
        - molecule verify
        - molecule destroy

    - stage: Roles tests
      name: Transform AIO Verification on Centos
      env:
        - "MOLECULE_ROLE_IMAGE=centos:7"
      script:
        - cd roles/transformers
        - molecule converge
        - sleep 1m
        - molecule verify
        - molecule destroy

    - stage: Roles tests
      name: Transform AIO Verification on Ubuntu
      env:
        - "MOLECULE_ROLE_IMAGE=ubuntu:20.04"
      script:
        - cd roles/transformers
        - molecule converge
        - sleep 1m
        - molecule verify
        - molecule destroy

    - stage: Roles tests
      name: Sync Service Verification on Centos
      env:
        - "MOLECULE_ROLE_IMAGE=centos:7"
      script:
        - cd roles/sync
        - molecule converge
        - sleep 1m
        - molecule verify
        - molecule destroy

    - stage: Roles tests
      name: Sync Service Verification on Ubuntu
      env:
        - "MOLECULE_ROLE_IMAGE=ubuntu:20.04"
      script:
        - cd roles/sync
        - molecule converge
        - sleep 1m
        - molecule verify
        - molecule destroy
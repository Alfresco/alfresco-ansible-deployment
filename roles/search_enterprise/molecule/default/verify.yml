---
- name: Verify
  hosts: all
  gather_facts: false
  tasks:
    - name: Populate service facts
      ansible.builtin.service_facts:

    - name: Check that Elasticsearch Connector service is up and running
      ansible.builtin.assert:
        that:
          - ansible_facts.services['elasticsearch-connector.service'] is defined
          - ansible_facts.services['elasticsearch-connector.service'].state == 'running'

    - name: Get errors in the journal of Elasticsearch Connector service
      become: true
      ansible.builtin.shell: "journalctl -u elasticsearch-connector.service -q | grep -E '(ERROR|WARN)'"
      failed_when: error_log.rc not in [0,1]
      register: error_log

    - name: Assert no errors or warnings are present in the service log
      ansible.builtin.assert:
        that:
          - error_log.stdout | length == 0
          - error_log.stderr | length == 0
        msg: "{{ error_log.stdout }} {{ error_log.stderr }}"

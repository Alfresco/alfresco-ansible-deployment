---
# tasks file for transformers
- name: ensure a list of packages installed
  package:
    name: "{{ item }}"
    state: present
  with_items: "{{ utils }}"

- name: Create temp dir
  file:
    path: "{{ temp_dir }}"
    state: directory
    mode: 'u=rwx,g=rwx,o=rx'
  become: true
  become_user: "{{ username }}"

- name: Check if ImageMagick is installed
  command:
    cmd: "convert --version"
  register: magick_exists
  failed_when: false
  changed_when: magick_exists.rc != 0

- name: Download imagemagick-distribution-linux.rpm
  get_url:
    url: "{{ IMAGEMAGICK_RPM_URL }}"
    dest: "{{ temp_dir }}/imagemagick-distribution-linux.rpm"
    mode: 0444
    url_username: "{{ nexus_user }}"
    url_password: "{{ nexus_password }}"
    timeout: 570
  register: download_img_dist
  until: download_img_dist is succeeded
  when: magick_exists.rc != 0

- name: Download imagemagick-distribution-libs-linux.rpm
  get_url:
    url: "{{ IMAGEMAGICK_LIB_RPM_URL }}"
    dest: "{{ temp_dir }}/imagemagick-distribution-libs-linux.rpm"
    mode: 0444
    url_username: "{{ nexus_user }}"
    url_password: "{{ nexus_password }}"
    timeout: 570
  register: download_img_libs_dist
  until: download_img_libs_dist is succeeded
  when: magick_exists.rc != 0

- name: Download imagemagick-epel-dep.rpm
  get_url:
    url: "{{ IMAGEMAGICK_DEP_RPM_URL }}"
    dest: "{{ temp_dir }}/imagemagick-epel-dep.rpm"
    mode: 0444
    timeout: 570
  register: download_img_epel_dep
  until: download_img_epel_dep is succeeded
  when: magick_exists.rc != 0

- name: install imagemagick-epel-dep
  yum:
    name: "{{ temp_dir }}/imagemagick-epel-dep.rpm"
    state: present
  when: download_img_epel_dep is succeeded

- name: install imagemagick-distribution-libs
  yum:
    name: "{{ temp_dir }}/imagemagick-distribution-libs-linux.rpm"
    state: present
  when: download_img_libs_dist is succeeded

- name: install imagemagick-distribution
  yum:
    name: "{{ temp_dir }}/imagemagick-distribution-linux.rpm"
    state: present
  when: download_img_dist is succeeded

- name: Check if LibreOffice exists
  command:
    cmd: "/opt/libreoffice6.3/program/soffice --version"
  register: loffice_exists
  failed_when: false
  changed_when: loffice_exists.rc != 0

- name: Download libreoffice-dist-{{ LIBREOFFICE_VERSION }}-linux.gz
  get_url:
    url: "{{ LIBREOFFICE_RPM_URL }}"
    dest: "{{ temp_dir }}/libreoffice-dist-linux.gz"
    url_username: "{{ nexus_user }}"
    url_password: "{{ nexus_password }}"
    mode: 0444
    timeout: 570
  register: libreoffice_download
  async: 900
  poll: 0
  when: loffice_exists.rc != 0

- name: Verifying if libreoffice finished downloading
  become: true
  become_user: root
  async_status:
    jid: "{{ libreoffice_download.ansible_job_id }}"
  register: job_result
  until: job_result.finished
  delay: 30
  retries: 15
  when: loffice_exists.rc != 0

- name: Extract libreoffice-dist-linux.gz
  become: yes
  unarchive:
    src: "{{ temp_dir }}/libreoffice-dist-linux.gz"
    dest: "{{ temp_dir }}/"
    remote_src: yes
  when: loffice_exists.rc != 0

- name: install LibreOffice
  shell: "yum localinstall -y {{ temp_dir }}/LibreOffice*/RPMS/*.rpm"
  args:
    warn: false
  when: loffice_exists.rc != 0
  changed_when: false

- name: Create transform-services folder
  file:
    path: "{{ ats_home }}"
    state: directory
    mode: 'u=rwx,g=rwx,o=rx'
    owner: "{{ username }}"
    group: "{{ group_name }}"

- name: Check if alfresco-pdf-renderer exe or archive exists
  block:
    - name: Check if alfresco-pdf-renderer exists
      stat:
        path: "{{ ats_home }}/alfresco-pdf-renderer"
      register: alfresco_pdf_renderer_exists
    - name: Check if alfresco-pdf-renderer archive exists
      stat:
        path: "{{ ats_home }}/alfresco-pdf-renderer-{{ PDF_RENDERER_VERSION }}-linux.tgz"
      register: alfresco_pdf_renderer_tgz_exists

- name: Download alfresco-pdf-renderer-linux.tgz
  block:
    - name: Download alfresco-pdf-renderer-linux.tgz
      become: true
      become_user: "{{ username }}"
      get_url:
        url: "{{ ALFRESCO_PDF_RENDERER_LIB_RPM_URL }}"
        dest: "{{ ats_home }}/alfresco-pdf-renderer-{{ PDF_RENDERER_VERSION }}-linux.tgz"
        url_username: "{{ nexus_user }}"
        url_password: "{{ nexus_password }}"
        mode: 'u=rwx,g=rwx,o=rx'
        timeout: 570
      register: download_pdf_renderer
      until: download_pdf_renderer is succeeded
      when: not alfresco_pdf_renderer_tgz_exists.stat.exists and not alfresco_pdf_renderer_exists.stat.exists

- name: Extract alfresco-pdf-renderer-linux.tgz
  become: true
  become_user: "{{ username }}"
  unarchive:
    src: "{{ ats_home }}/alfresco-pdf-renderer-{{ PDF_RENDERER_VERSION }}-linux.tgz"
    dest: "{{ ats_home }}"
    remote_src: yes
  when: not alfresco_pdf_renderer_exists.stat.exists

- name: Remove alfresco-pdf-renderer-linux.tgz
  block:
  - name: Remove from content services
    file:
      path: "{{ binaries_folder }}/content-services-{{ acs.version }}/alfresco-pdf-renderer/alfresco-pdf-renderer-{{ PDF_RENDERER_VERSION }}-linux.tgz"
      state: absent
  - name: Remove from transform services
    file:
      path: "{{ ats_home }}/alfresco-pdf-renderer-{{ PDF_RENDERER_VERSION }}-linux.tgz"
      state: absent

- name: Download alfresco-transform-core-aio-boot-{{ transform.version }}.jar
  get_url:
    url: "{{ nexus_repository.releases }}/org/alfresco/alfresco-transform-core-aio-boot/{{ transform.version }}/alfresco-transform-core-aio-boot-{{ transform.version }}.jar"
    dest: "{{ binaries_folder }}/transform-service/alfresco-transform-core-aio-boot-{{ transform.version }}.jar"
    owner: "{{ username }}"
    group: "{{ group_name }}"
    mode: 'u=rwx,g=rwx,o=rx'
    url_username: "{{ nexus_user }}"
    url_password: "{{ nexus_password }}"
    timeout: 570
  register: download_result
  until: download_result is succeeded

- name: Check for ATS_HOME in "{{ config_folder }}/setenv.sh"
  shell: cat {{ config_folder }}/setenv.sh | grep ATS_HOME
  register: test_ats_home
  failed_when: false
  changed_when: test_ats_home.rc != 0

- name: Add paths to setenv file
  become: true
  become_user: "{{ username }}"
  blockinfile:
    path: "{{ config_folder }}/setenv.sh"
    marker: "# {mark} ATS ENV VARS"
    block: |
      export LIBREOFFICE_HOME={{ libreoffice_home }}
      export IMAGEMAGICK_HOME={{ imagemagick_home }}
      export IMAGEMAGICK_DYN=/usr/lib64
      export IMAGEMAGICK_CONFIG=${IMAGEMAGICK_HOME}/config-Q16HDRI
      export IMAGEMAGICK_CODERS=${IMAGEMAGICK_HOME}/modules-Q16HDRI/coders
      export IMAGEMAGICK_EXE=/usr/bin/magick
      export IMAGEMAGICK_EXE=/usr/bin/convert
      export ATS_HOME={{ binaries_folder }}/transform-service
      export ATS_TENGINE_AIO_HOST={{ ats_tengine_aio_host }}
      export ATS_SHARED_FS_HOST={{ sfs_host }}
    insertafter: EOF
  when: test_ats_home.rc != 0

- name: Add AIO startup script
  become: true
  become_user: "{{ username }}"
  template:
    src: ats-ate-aio.sh
    dest: "{{ binaries_folder }}/ats-ate-aio.sh"
    owner: "{{ username }}"
    group: "{{ group_name }}"
    mode: 'u=rwx,g=rwx,o=rx'
    force: yes

- name: Add alfresco-tengine-aio service
  become: true
  template:
    src: alfresco-tengine-aio.service
    dest: "/etc/systemd/system/alfresco-tengine-aio.service"
    owner: "{{ username }}"
    group: "{{ group_name }}"
    mode: 'u=rwx,g=rwx,o=rx'
    force: yes

- name: clean all
  command: yum clean all
  args:
    warn: false
  changed_when: false

- name: Getting go_signal tengine-aio service to start
  block:
  - name: Check for activemq
    wait_for:
      host: "{{ activemq_host }}"
      port: 8161
    register: activemq_go

- name: Enable and start AIO service
  systemd:
    name: alfresco-tengine-aio.service
    state: started
    enabled: true
  when: not activemq_go.failed

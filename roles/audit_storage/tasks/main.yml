---
# tasks file for audit_storage
- name: Download audit storage distribution {{ audit_storage_version }}
  ansible.builtin.get_url:
    url: "{{ audit_storage_zip_url }}"
    dest: "{{ download_location }}/{{ audit_storage_artifact_name }}-{{ audit_storage_version }}.zip"
    checksum: sha1:{{ lookup('url', audit_storage_zip_sha1_url, username=nexus_user, password=nexus_password) }} # pragma: allowlist secret
    mode: "0644"
    url_username: "{{ nexus_user }}"
    url_password: "{{ nexus_password }}"

- name: Install Audit Storage
  become: true
  block:
    - name: Create directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: "{{ audit_storage_username }}"
        group: "{{ audit_storage_group_name }}"
        mode: "0755"
      loop:
        - "{{ audit_storage_binaries_dir }}"
        - "{{ audit_storage_config_dir }}"

    - name: Extract distribution zip in binaries
      ansible.builtin.unarchive:
        src: "{{ download_location }}/{{ audit_storage_artifact_name }}-{{ audit_storage_version }}.zip"
        dest: "{{ audit_storage_binaries_dir }}"
        remote_src: true
        creates: "{{ audit_storage_binaries_dir }}/README.md"
        owner: "{{ audit_storage_username }}"
        group: "{{ audit_storage_group_name }}"

    - name: Install service
      ansible.builtin.include_role:
        name: systemd_service
      vars:
        systemd_service_unit_name: "alfresco-audit-storage"
        systemd_service_unit_description: "Alfresco Audit Storage"
        systemd_service_exec_start: "{{ audit_storage_java_bin_path }} -jar {{ audit_storage_artifact_path }}"
        systemd_service_user: "{{ audit_storage_username }}"
        systemd_service_environment: >-
          {{ audit_storage_default_environment |
          combine(audit_storage_environment) }}

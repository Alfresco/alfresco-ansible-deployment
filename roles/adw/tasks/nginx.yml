---
- name: Use NGINX official repo
  become: true
  block:
    - name: Enable nginx repo.
      template:
        src: nginx.repo
        dest: /etc/yum.repos.d/nginx.repo
        owner: root
        group: root
        mode: 'u=rw,g=r,o=r'

    - name: Wait for yum lock release (Ansible 2.8.0 workaround)
      shell: ps -aux | grep yum
      register: yum_lock
      retries: 20
      delay: 6
      until: yum_lock.stdout_lines|length <= 2
      changed_when: false
  when: ansible_mkg_mgr != 'apt'

- name: Ensure nginx in adw.
  package:
    name: "{{ nginx_package_name }}"
    state: present

- name: Ensure nginx_vhost_path exists.
  file:
    path: "{{ nginx_vhost_path }}"
    state: directory

- name: Remove legacy vhosts.conf file.
  file:
    path: "{{ nginx_vhost_path }}/vhosts.conf"
    state: absent

- name: Add managed vhost config files.
  template:
    src: alfresco_adw.conf
    dest: "{{ nginx_vhost_path }}/alfresco_adw.conf"
    force: true
    owner: root
    group: root
    mode: 'u=rw,g=r,o=r'
  notify:
    - get-services
    - enable-nginx
    - start-nginx
    - restart-nginx

- name: Set nis_enabled flag on and keep it persistent across reboots
  become: true
  seboolean:
    name: nis_enabled
    state: true
    persistent: true
  when: ansible_selinux.status == "enabled"

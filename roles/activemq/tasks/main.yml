---
- name: Download activemq tar
  get_url:
    url: "{{ dependencies_url.activemq }}"
    checksum: sha512:{{ dependencies_url.activemq_sha512_checksum_url }}
    dest: "{{ download_location }}/apache-activemq-{{ dependencies_version.activemq }}-bin.tar.gz"
    mode: 'u=rwx,g=rwx,o=rx'
    owner: "{{ username }}"
    group: "{{ group_name }}"
  register: activemq_download
  async: 900
  poll: 0
  changed_when: false

- name: Check on activemq download async task
  async_status:
    jid: "{{ activemq_download.ansible_job_id }}"
  register: job_result
  until: job_result.finished
  delay: 5
  retries: 300

- name: Install ActiveMQ
  become: true
  block:
    - name: Extract apache-activemq-{{ dependencies_version.activemq }}-bin.tar.gz into
      unarchive:
        src: "{{ download_location }}/apache-activemq-{{ dependencies_version.activemq }}-bin.tar.gz"
        dest: "/opt"
        remote_src: true
        owner: "{{ username }}"
        group: "{{ group_name }}"
        creates: "{{ activemq_home }}/bin/activemq"
      when: job_result is succeeded

    - name: "Copy configuration files to {{ config_folder }}/activemq"
      copy:
        remote_src: true
        src: "{{ activemq_home }}/conf"
        dest: "{{ config_folder }}/activemq"
        owner: "{{ username }}"
        group: "{{ group_name }}"
        mode: 0755

    - name: Remove configuration folder from binaries folder
      file:
        path: "{{ activemq_home }}/conf"
        state: absent

    - name: "Copy data files to {{ data_folder }}/activemq"
      copy:
       remote_src: true
       src: "{{ activemq_home }}/data"
       dest: "{{ data_folder }}/activemq"
       owner: "{{ username }}"
       group: "{{ group_name }}"
       mode: 'u=rwx,g=rwx,o=rx'

    - name: Remove data folder from binaries folder
      file:
        path: "{{ activemq_home }}/data"
        state: absent

    - name: Allow external connections to webconsole
      replace:
        path: "{{ activemq_conf }}/jetty.xml"
        regexp: "127.0.0.1"
        replace: "0.0.0.0"
        owner: "{{ username }}"
        group: "{{ group_name }}"

    - name: Change location of ActiveMQ logs
      replace:
        path: "{{ activemq_conf }}/log4j.properties"
        regexp: "activemq.data"
        replace: "activemq.log"
        owner: "{{ username }}"
        group: "{{ group_name }}"

    - name: Add activemq_home and host to setenv script
      blockinfile:
        path: "{{ config_folder }}/setenv.sh"
        marker: "# {mark} ACTIVEMQ ENV VARS"
        owner: "{{ username }}"
        group: "{{ group_name }}"
        block: |
          export ACTIVEMQ_HOME={{ activemq_home }}
          export ACTIVEMQ_HOST={{ activemq_host }}

    - name: Add activemq wrapper script
      become: true
      template:
        src: "activemq.sh"
        dest: "{{ binaries_folder }}"
        owner: "{{ username }}"
        group: "{{ group_name }}"
        mode: 'u=rwx,go=rx'
      notify:
        - restart-activemq

    - name: Add activemq.service
      template:
        src: activemq.service
        dest: /etc/systemd/system/activemq.service
        mode: 0644
      notify:
        - enable-activemq
        - restart-activemq

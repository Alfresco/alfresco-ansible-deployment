---
- name: Check for a target host certificate
  ansible.builtin.copy:
    src: "{{ certificate_container }}"
    mode: 0400
    dest: "{{ download_location }}"
  register: certcp
  failed_when: certcp.failed and 'Could not find or access' not in certcp.msg

- name: Add certificates in a java keystore
  when: certcp.msg is undefined
  block:
    - name: Read certificates
      register: cert_aliases
      shell:
        chdir: "{{ download_location }}"
        creates: "{{ certcp.checksum }}"
        cmd: >
          {{ java_home }}/bin/keytool
          -list
          -rfc
          -storepass {{ certificate_container_password }}
          -keystore {{ certificate_container | basename }}
          2> {{ certcp.checksum }} |
          awk '/^Alias name: /{ print substr($0,13) }'
    - name: Import certificates to a keystore
      community.general.java_cert:
        executable: "{{ java_home }}/bin/keytool"
        pkcs12_alias: "{{ cert_aliases.stdout_lines | first }}"
        pkcs12_path: >-
          {{ download_location }}/{{ certificate_container | basename }}
        pkcs12_password: "{{ certificate_container_password }}"
        cert_alias: "{{ inventory_hostname }}"
        keystore_type: JCEKS
        keystore_path: "{{ java_home }}/lib/security/keystore.jceks"
        keystore_pass: "{{ java_keystore_pass }}"
        state: present
        keystore_create: true
  rescue:
    - name: Clean keystore tmp file as something went wrong
      file:
        path: "{{ download_location }}/{{ certcp.checksum }}"
        state: absent
    - name: Force fail on certificate import failure
      fail:
        msg: |
          Playbook stops here as it was not able to complete certificate
          import. The Java keystore is not up to date or does not exist.
